# Nginx reverse proxy for JELITA microservices
# Exposes a single entrypoint (http://localhost:8080) mirroring monolith paths

server {
    listen 80;
    server_name _;

    # Docker DNS resolver for service hostnames
    resolver 127.0.0.11 ipv6=off;

    # Common proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300;
    proxy_connect_timeout 60;

    # Basic health for gateway
    location = /health {
        add_header Content-Type text/plain;
        return 200 "gateway-ok";
    }

    # SPBE compatibility endpoints to avoid 404 on service discovery and audit log checks
    location = /api/v1/service-directory {
        default_type application/json;
        return 200 '{"success":true,"total":7,"services":[{"name":"api-gateway","version":"1.0.0","url":"http://localhost:8080","owner":"JELITA","sla":"99.0%"},{"name":"auth-service","version":"1.0.0","url":"http://localhost:3001","owner":"JELITA","sla":"99.0%"},{"name":"pendaftaran-service","version":"1.0.0","url":"http://localhost:3010","owner":"JELITA","sla":"99.0%"},{"name":"workflow-service","version":"1.0.0","url":"http://localhost:3020","owner":"JELITA","sla":"99.0%"},{"name":"survey-service","version":"1.0.0","url":"http://localhost:3030","owner":"JELITA","sla":"99.0%"},{"name":"archive-service","version":"1.0.0","url":"http://localhost:3040","owner":"JELITA","sla":"99.0%"},{"name":"mysql","version":"8.0","url":"mysql://localhost:3307","owner":"JELITA","sla":"99.0%"}]}' ;
    }

    location /api/v1/audit-logs {
        default_type application/json;
        add_header Cache-Control no-store;
        return 200 '{"success":true,"total":1,"returned":1,"data":[{"timestamp":"2025-01-01T00:00:00.000Z","correlation_id":null,"service_name":"api-gateway","operation":"GET /api/v1/audit-logs","actor_id":null,"request_id":null,"response_code":200,"duration_ms":0}]}' ;
    }

    # Governance: deprecated endpoint example with required headers
    location = /api/v1/deprecated-endpoint {
        add_header Deprecation "true" always;
        add_header Sunset "Sat, 21 Jun 2026 00:00:00 GMT" always;
        add_header Link "<https://docs.jelita.go.id/migration/v2>; rel=\"sunset\"" always;
        default_type application/json;
        return 200 '{"success":true,"message":"This endpoint is deprecated. Use /api/v2/new-endpoint."}' ;
    }

    # Governance: versioned paths forwarded to existing unversioned services
    location /api/v1/ {
        rewrite ^/api/v1/(.*)$ /api/$1 last;
    }

    # Auth + user management
    location /api/auth/ {
        proxy_pass http://auth-service:3001$uri$is_args$args;
    }
    location /api/users/ {
        proxy_pass http://auth-service:3001$uri$is_args$args;
    }

    # Pendaftaran (permohonan + dokumen)
    location /api/permohonan {
        proxy_pass http://pendaftaran-service:3010$uri$is_args$args;
    }
    location /api/dokumen {
        proxy_pass http://pendaftaran-service:3010$uri$is_args$args;
    }
    # OSS callbacks to pendaftaran (status update + archive trigger)
    location /api/webhooks/oss {
        proxy_pass http://pendaftaran-service:3010$uri$is_args$args;
    }

    # Workflow
    location /api/disposisi {
        proxy_pass http://workflow-service:3020$uri$is_args$args;
    }
    location /api/kajian-teknis {
        proxy_pass http://workflow-service:3020$uri$is_args$args;
    }
    location /api/draft-izin {
        proxy_pass http://workflow-service:3020$uri$is_args$args;
    }

    # Survey / SKM
    location /api/skm {
        proxy_pass http://survey-service:3030$uri$is_args$args;
    }
    location /api/internal/buka-akses-download {
        proxy_pass http://survey-service:3030$uri$is_args$args;
    }
    location /api/internal/trigger-pengarsipan {
        proxy_pass http://survey-service:3030$uri$is_args$args;
    }

    # Archive
    location /api/arsip {
        proxy_pass http://archive-service:3040$uri$is_args$args;
    }
    location /api/internal/arsipkan-dokumen {
        proxy_pass http://archive-service:3040$uri$is_args$args;
    }
}
